(()=>{function _(){document.getElementById("launch_new_window").classList.remove("hidden")}function f(){document.getElementById("cookie_error").classList.remove("hidden")}function h(){document.getElementById("request_storage_access").classList.remove("hidden")}function p(){document.getElementById("request_storage_access_error").classList.remove("hidden"),document.getElementById("request_storage_access").classList.add("hidden")}function d(e){window.open(e.relaunch_init_url),document.getElementById("button_launch_new_window").disabled=!0,document.getElementById("request_storage_access").classList.add("hidden"),document.getElementById("request_storage_access_error").classList.add("hidden")}function y(e,n,o){return new Promise((m,s)=>{let r=new URL(o.oidc_url).origin,c=o.target,a=window.parent||window.opener,w=c==="_parent"?a:a.frames[c];o.origin_support_broken&&(r="*");let g=setTimeout(()=>{console.log("postMessage timeout"),s(new Error("Timeout while waiting for platform response"))},2e3),i=t=>{typeof t.data=="object"&&t.data.subject==="lti.put_data.response"&&t.data.message_id===e&&(t.origin===r||r==="*")&&(removeEventListener("message",i),clearTimeout(g),t.data.error&&(console.log(t.data.error.code),console.log(t.data.error.message),s(new Error(t.data.errormessage))),m())};window.addEventListener("message",i),w.postMessage({subject:"lti.put_data",message_id:e,key:"atomic_lti_"+e,value:n},r)})}function u(e){document.requestStorageAccess().then(()=>{S(e),window.location.replace(e.response_url)}).catch(n=>{console.log(n),p()})}function E(e){return document.cookie.match("(^|;)\\s*open_id_"+e.state)}function S(e){document.cookie="open_id_"+e.state+"="+e.csrf_token+"; path=/; max-age=300; SameSite=None ;"}function L(){return typeof document.hasStorageAccess=="function"&&typeof document.requestStorageAccess=="function"}async function l(e){let n=()=>{window.location.replace(e.response_url)};if(E(e))return n();if(e.lti_storage_params)try{return await y(e.state,e.csrf_token,e.lti_storage_params),n()}catch(o){console.log(o)}if(window.self!==window.top){if(_(),L())try{if(!await document.hasStorageAccess()){h();return}}catch(o){console.log(o)}}else f()}window.onload=async()=>{l(window.SETTINGS),window.LAUNCHED=!0,document.getElementById("request_storage_access_link").onclick=()=>u(window.SETTINGS),document.getElementById("button_launch_new_window").onclick=()=>d(window.SETTINGS)};})();
