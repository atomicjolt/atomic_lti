(()=>{function g(){document.getElementById("launch_new_window").classList.remove("hidden")}function f(){document.getElementById("cookie_error").classList.remove("hidden")}function _(){document.getElementById("request_storage_access").classList.remove("hidden")}function h(){document.getElementById("request_storage_access_error").classList.remove("hidden")}function p(e,r,o){return new Promise((l,n)=>{let s=new URL(o.oidc_url).origin,a=o.target,c=window.parent||window.opener,m=a==="_parent"?c:c.frames[a];o.origin_support_broken&&(s="*");let w=setTimeout(()=>{console.log("postMessage timeout"),n(new Error("Timeout while waiting for platform response"))},2e3),i=t=>{typeof t.data=="object"&&t.data.subject==="lti.put_data.response"&&t.data.message_id===e&&(t.origin===s||s==="*")&&(removeEventListener("message",i),clearTimeout(w),t.data.error&&(console.log(t.data.error.code),console.log(t.data.error.message),n(new Error(t.data.errormessage))),l())};window.addEventListener("message",i),m.postMessage({subject:"lti.put_data",message_id:e,key:"atomic_lti_"+e,value:r},s)})}function u(e){document.requestStorageAccess().then(()=>{y(e),window.location.replace(e.response_url)}).catch(r=>{console.log(r),h()})}function S(e){return document.cookie.match("(^|;)\\s*open_id_"+e.state)}function y(e){document.cookie="open_id_"+e.state+"="+e.csrf_token+"; path=/; max-age=300; SameSite=None ;"}function E(){return typeof document.hasStorageAccess=="function"&&typeof document.requestStorageAccess=="function"}async function d(e){let r=()=>{window.location.replace(e.response_url)};if(S(e))return r();if(e.lti_storage_params)try{return await p(e.state,e.csrf_token,e.lti_storage_params),r()}catch(o){console.log(o)}if(window.self!==window.top){if(g(),E())try{if(!await document.hasStorageAccess()){_();return}}catch(o){console.log(o)}}else f()}window.onload=async()=>{d(window.SETTINGS),window.LAUNCHED=!0,document.getElementById("request_storage_access_link").onclick=()=>u(window.SETTINGS)};})();
